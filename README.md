# SleepArchiver

English: see [README_EN.md](README_EN.md)

Приложение для управления данными сна с часов Sleeptracker (SleepTracker, Sleep Tracker).

## Описание

SleepArchiver - это десктопное приложение для загрузки, хранения и анализа данных о сне с часов Sleeptracker. Приложение позволяет отслеживать качество сна, продолжительность, количество пробуждений и другие метрики.

Это форк оригинального проекта Pavel Fatin (2013), полностью переписанный на современный стек технологий.

## Возможности

- Загрузка данных с часов Sleeptracker через серийный порт
- Хранение истории сна в формате XML (GZIP)
- Визуализация данных сна (график качества сна, пробуждения)
- Редактирование записей сна (время, условия, заметки)
- Экспорт/импорт данных в CSV
- Статистика и метрики сна
- Многоязычный интерфейс (английский, русский)
- Кроссплатформенность (macOS, Windows, Linux)

## Технологии

### Текущая версия (2026)
- **Java 21** - современная LTS версия Java
- **JavaFX** - кроссплатформенный UI фреймворк
- **Gradle 8.12** - система сборки
- **jSerialComm** - работа с серийным портом (замена RXTX)
- **Jakarta JAXB** - XML сериализация
- **Apache Commons CSV** - работа с CSV
- **JUnit 5** - тестирование (69 тестов)

### Оригинальная версия (2013)
- Java 6, Swing, Ant, RXTX, JGoodies Forms, AppFramework

## Требования

- Java 21 или выше
- Gradle 8.12 или выше (поставляется с wrapper)
- Часы Sleeptracker с USB кабелем

## Установка

### Готовые сборки

Скачайте готовые установочные пакеты из раздела [Releases](https://github.com/JoTesla/sleeparchiver/releases):
- **macOS**: SleepArchiver-2.0.0.dmg 
#### Особенности установки на macOS

Так как файл не имеет цифровой подписи, macOS может предотвратить запуск приложения. Выполните следующие шаги:

1. Откройте скачанный файл `.dmg` и перетащите приложение в папку `Applications`.
2. Запустите SleepArchiver через Launchpad, Spotlight или Finder — система может показать предупреждение о неподписанном приложении. Нажмите "Отмена" (не удаляйте приложение).
3. Откройте Системные настройки → Конфиденциальность и безопасность.
4. В нижней части окна появится сообщение о блокировке приложения — нажмите "Всё равно открыть" ("Open Anyway").

Примечание: альтернативный способ — удерживая клавишу Control, щёлкните по приложению в Finder и выберите "Открыть", затем подтвердите запуск в появившемся диалоге.


- **Windows**: SleepArchiver-2.0.0.msi
- **Linux**: SleepArchiver-2.0.0.deb

## Сборка из исходников

```bash
# Клонирование репозитория
git clone https://github.com/JoTesla/sleeparchiver.git
cd sleeparchiver

# Сборка проекта
./gradlew build

# Запуск приложения
./gradlew run

# Запуск тестов
./gradlew test

# Создание дистрибутива (DMG для macOS, MSI для Windows, DEB для Linux)
./gradlew jpackage
```

## Создание релиза

Для создания нового релиза с автоматической сборкой для всех платформ:

```bash
# Создать и запушить тег версии
git tag v2.0.0
git push origin v2.0.0
```

GitHub Actions автоматически соберет DMG (macOS), MSI (Windows) и DEB (Linux) и создаст Release с артефактами.

## Использование

### Важно перед подключением

**КРИТИЧЕСКИ ВАЖНО**:
- Часы должны работать с **ВКЛЮЧЕННЫМ будильником**. Если будильник отключен, часы не фиксируют данные о сне!
- Перед подключением к компьютеру **переведите часы в режим "Date"** - долистайте кнопками до экрана с данными о сне

### Процесс загрузки данных

1. Убедитесь, что будильник в часах был включен во время сна
2. На часах долистайте до экрана "Date" (экран с данными о сне)
3. Подключите часы Sleeptracker к компьютеру через USB
4. Запустите приложение
5. Выберите серийный порт и скорость (обычно 19200 baud)
6. Нажмите "Acquire" для загрузки данных с часов
7. Данные автоматически сохраняются в формате .xmz (GZIP XML)

**Внимание**: После чтения данные остаются в часах, но часы выходят из режима передачи. Для повторного чтения нужно заново открыть страницу Date на часах.

## Формат данных

- **.xmz** - основной формат хранения (GZIP сжатый XML с JAXB)
- **.csv** - экспорт/импорт в табличном формате

## Структура проекта

```
src/main/java/              - исходный код приложения
├── model/                  - модель данных (Night, Device, Document)
├── gui/                    - JavaFX интерфейс
│   ├── main/              - главное окно и команды
│   ├── night/             - диалог редактирования записи
│   ├── conditions/        - условия сна
│   ├── download/          - диалог загрузки с часов
│   └── preferences/       - настройки
└── lang/                  - i18n утилиты

src/main/resources/         - ресурсы (иконки, файлы локализации)
src/test/java/              - тесты JUnit 5
```

## Лицензия

GPL v3 - см. файл LICENSE

## Автор

- **Оригинальный проект**: Pavel Fatin (2010-2013)
- **Форк и миграция**: Evgen Tamarovsky (JoTesla) (2026)

## История

- **2010-2013**: Оригинальная версия на Java 6/Swing/Ant
- **2026**: Полная миграция на Java 21/JavaFX/Gradle с добавлением русской локализации

## Известные проблемы и особенности

### Требования к часам
- **Будильник должен быть ВКЛЮЧЕН** - если будильник отключен, часы не записывают данные о сне
- **Режим "Date"** - перед подключением нужно долистать до экрана с данными о сне на часах

### Особенности протокола
- Часы Sleeptracker отдают данные ОДИН РАЗ при открытии страницы данных
- После чтения данные **НЕ стираются**, но часы выходят из режима передачи
- Для повторного чтения нужно **заново открыть страницу Date** на часах
- Требуется точная настройка baud rate (обычно 19200)
- Handshake протокол может не работать - часы начинают стриминг сразу при открытии экрана Date

## Ссылки

- GitHub: https://github.com/JoTesla/sleeparchiver
- Оригинальный проект: https://code.google.com/archive/p/sleeparchiver/
